var app=require("express")(),http=require("http").createServer(app),io=require("socket.io")(http),ejs=require("ejs"),fs=require("fs"),index_file=fs.readFileSync(__dirname+"/index.ejs","utf8"),mysql=require("mysql"),con=mysql.createConnection({host:"localhost",user:"ilias",database:"ilias",password:"ilias"});con.connect();var chat_rooms=[],tokens=[];app.get("/srchat/:token",function(a,b){console.log(a.params.token),con.query("SELECT * FROM sr_chat_token WHERE token = \""+a.params.token+"\"",function(a,c){if(!a){var d=Math.round(new Date().getTime()/1e3);0===c.length||c[0].valid_until_unix<d?(console.log("invalid token"),b.sendFile(__dirname+"/error.html")):(tokens[c[0].token]={public_name:c[0].public_name,usr_id:c[0].usr_id,chat_room_id:c[0].chat_room_id},console.log("token verified for user "+c[0].usr_id),b.send(ejs.render(index_file,{token:c[0].token})))}else console.log("error while performing query. ",a.message)})}),io.use(function(a,b){if("undefined"==typeof a.handshake.query||"string"!=typeof a.handshake.query.token)return b(new Error("missing token in handshake"));var c=a.handshake.query.token;return c in tokens?(user_info=tokens[c],"number"!=typeof user_info.usr_id||"number"!=typeof user_info.chat_room_id||"string"!=typeof user_info.public_name)?b(new Error("token information invalid or incomplete")):(a.usr_id=user_info.usr_id,a.chat_room_id=user_info.chat_room_id,a.public_name=user_info.public_name,b()):b(new Error("token not found in database"))}),io.on("connection",function(a){console.log("user connected"),a.join("sr_chat_"+a.chat_room_id),a.on("disconnect",function(){console.log("user disconnected")}),a.on("chat_msg",function(b){console.log("message: "+b),io.to("sr_chat_"+a.chat_room_id).emit("chat_msg",b)})}),http.listen(3e3,function(){console.log("listening on *:3000")});