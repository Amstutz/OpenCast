var app=require("express")(),http=require("http").createServer(app),io=require("socket.io")(http),ejs=require("ejs"),fs=require("fs"),index_file=fs.readFileSync(__dirname+"/index.ejs","utf8"),moment=require("moment");const uuidv4=require("uuid/v4");var mysql=require("mysql"),con=mysql.createConnection({host:"localhost",user:"ilias",database:"ilias",password:"ilias"});con.connect();var tokens=[];app.get("/srchat/:token",function(a,b){console.log(a.params.token);var c=Math.round(new Date().getTime()/1e3);con.query("SELECT * FROM sr_chat_token WHERE token = \""+a.params.token+"\"",function(d,e){d?console.log("error while performing query. ",d.message):0===e.length||e[0].valid_until_unix<c?(console.log("invalid token"),b.sendFile(__dirname+"/error.html")):(tokens[e[0].token]={public_name:e[0].public_name,usr_id:e[0].usr_id,chat_room_id:e[0].chat_room_id},console.log("token verified for user "+e[0].usr_id),con.query("SELECT m.*, u.login, u.firstname, u.lastname, p.value FROM sr_chat_message m LEFT JOIN usr_data u ON u.usr_id = m.usr_id LEFT JOIN usr_pref p ON p.usr_id = u.usr_id AND p.keyword = \"public_profile\" AND (p.value = \"y\" OR p.value = \"g\") WHERE m.chat_room_id = "+e[0].chat_room_id+" ORDER BY sent_at ASC",function(c,d){return c?void console.log("error while performing query. ",c.message):(d=d.map(function(a){if(null==a.login)var b="[deleted]";else if(null==a.value)var b=a.login;else var b=a.firstname+" "+a.lastname+" ("+a.login+")";return Object.assign({},a,{sent_at:moment(a.sent_at).format("HH:mm:ss"),public_name:b})}),b.send(ejs.render(index_file,{token:a.params.token,messages:d})))}))}),con.query("DELETE FROM sr_chat_token WHERE token = \""+a.params.token+"\""),con.query("DELETE FROM sr_chat_token WHERE valid_until_unix < "+c)}),io.use(function(a,b){if("undefined"==typeof a.handshake.query||"string"!=typeof a.handshake.query.token)return console.log("missing token in handshake"),b(new Error("missing token in handshake"));console.log(a.handshake.query);var c=a.handshake.query.token;return c in tokens?(user_info=tokens[c],"number"!=typeof user_info.usr_id||"number"!=typeof user_info.chat_room_id||"string"!=typeof user_info.public_name)?(console.log("token information invalid or incomplete"),b(new Error("token information invalid or incomplete"))):(a.usr_id=user_info.usr_id,a.chat_room_id=user_info.chat_room_id,a.public_name=user_info.public_name,b()):(console.log("token not found in database: "+c),b(new Error("token not found in database")))}),io.on("connection",function(a){console.log("user connected"),a.join("sr_chat_"+a.chat_room_id),a.on("disconnect",function(){console.log("user disconnected")}),a.on("chat_msg",function(b){console.log("message: "+b);var c=new Date,d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),e=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();io.to("sr_chat_"+a.chat_room_id).emit("chat_msg",{public_name:a.public_name,msg:b,sent_at:e}),con.query("INSERT INTO sr_chat_message (id, chat_room_id, usr_id, message, sent_at) VALUES (\""+uuidv4()+"\","+a.chat_room_id+","+a.usr_id+",\""+b+"\", \""+(d+" "+e)+"\")")})}),http.listen(3e3,function(){console.log("listening on *:3000")});