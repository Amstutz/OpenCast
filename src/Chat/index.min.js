var client_id=process.argv[2];"string"==typeof client_id||(console.log("Please pass a client ID as an argument"),process.exit());var app=require("express")(),http=require("http").createServer(app),io=require("socket.io")(http),ejs=require("ejs"),fs=require("fs"),index_file=fs.readFileSync(__dirname+"/index.ejs","utf8");QueryUtils=require(__dirname+"/QueryUtils");var QueryUtils=new QueryUtils,tokens=[];app.get("/srchat/css",function(a,b){b.sendFile(__dirname+"/chat.css")}),app.get("/srchat/:token",function(a,b){QueryUtils.checkTokenAndFetchMessages(a.params.token,function(c,d){return d?(tokens[a.params.token]={public_name:c.public_name,usr_id:c.usr_id,chat_room_id:c.chat_room_id},c.client_id=client_id,c.base_url=a.protocol+"://"+a.hostname,b.send(ejs.render(index_file,c))):void(console.log(c),b.sendFile(__dirname+"/error.html"))})}),io.use(function(a,b){if("undefined"==typeof a.handshake.query||"string"!=typeof a.handshake.query.token)return console.log("missing token in handshake"),b(new Error("missing token in handshake"));var c=a.handshake.query.token;return c in tokens?(user_info=tokens[c],"number"!=typeof user_info.usr_id||"number"!=typeof user_info.chat_room_id||"string"!=typeof user_info.public_name)?(console.log("token information invalid or incomplete"),b(new Error("token information invalid or incomplete"))):(a.usr_id=user_info.usr_id,a.chat_room_id=user_info.chat_room_id,a.public_name=user_info.public_name,b()):(console.log("token not found in database: "+c),b(new Error("token not found in database")))}),io.on("connection",function(a){console.log("user connected"),a.join("sr_chat_"+a.chat_room_id),a.on("disconnect",function(){console.log("user disconnected")}),a.on("chat_msg",function(b){var c=new Date,d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),e=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();io.to("sr_chat_"+a.chat_room_id).emit("chat_msg",{public_name:a.public_name,msg:b,sent_at:e,usr_id:a.usr_id}),QueryUtils.insertMessage(a.chat_room_id,a.usr_id,b,d+" "+e)})}),http.listen(3e3,function(){console.log("listening on *:3000")});