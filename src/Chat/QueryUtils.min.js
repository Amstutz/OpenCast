function QueryUtils(a){var b=require("fs"),c=require("ini"),d=c.parse(b.readFileSync(__dirname+"/../../../../../../../../../data/"+a+"/client.ini.php","utf-8"));this.uuidv4=require("uuid/v4"),this.moment=require("moment"),this.mysql=require("mysql"),this.con=this.mysql.createPool({host:d.db.host,user:d.db.user,database:d.db.name,password:d.db.pass})}QueryUtils.prototype.getOldMessages=function(a,b){var c=this.con,d=this.moment;c.query("SELECT m.*, u.login, u.firstname, u.lastname, p.value FROM sr_chat_message m LEFT JOIN usr_data u ON u.usr_id = m.usr_id LEFT JOIN usr_pref p ON p.usr_id = u.usr_id AND p.keyword = \"public_profile\" AND (p.value = \"y\" OR p.value = \"g\") WHERE m.chat_room_id = "+a+" ORDER BY sent_at ASC",function(a,c){a?b({error:"error while performing query. "+a.message},!1):(c=c.map(function(a){if(null==a.login)var b="[deleted]";else if(null==a.value)var b=a.login;else var b=a.firstname+" "+a.lastname+" ("+a.login+")";return Object.assign({},a,{sent_at:d(a.sent_at).format("HH:mm:ss"),public_name:b})}),b({messages:c},!0))})},QueryUtils.prototype.checkTokenAndFetchMessages=function(a,b){var c=Math.round(new Date().getTime()/1e3),d=this.con,e=this;d.query("SELECT * FROM sr_chat_token WHERE token = \""+a+"\"",function(f,g){f?b({error:"error while performing query. "+f.message},!1):0===g.length?b({error:"invalid token (not found in db): "+a},!1):g[0].valid_until_unix<c?b({error:"invalid token (expired): "+a},!1):e.getOldMessages(g[0].chat_room_id,function(c,d){d?b({token:a,public_name:g[0].public_name,usr_id:g[0].usr_id,chat_room_id:g[0].chat_room_id,messages:c.messages},!0):b(c,!1)}),d.query("DELETE FROM sr_chat_token WHERE token = \""+a+"\""),d.query("DELETE FROM sr_chat_token WHERE valid_until_unix < "+c)})},QueryUtils.prototype.insertMessage=function(a,b,c,d){this.con.query("INSERT INTO sr_chat_message (id, chat_room_id, usr_id, message, sent_at) VALUES (\""+this.uuidv4()+"\","+a+","+b+",\""+c+"\", \""+d+"\")")},module.exports=QueryUtils;