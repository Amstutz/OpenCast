const yargs=require("yargs"),argv=yargs.option("client-id",{description:"ILIAS Client ID",alias:"c",type:"string"}).option("ilias-dir",{description:"root dir of this ILIAS installation",alias:"d",type:"string",default:"/var/www/ilias"}).option("port",{description:"port which the chat server listens to",alias:"p",type:"number",default:3e3}).option("ip",{description:"IP address which the chat server listens to",type:"string",default:"0.0.0.0"}).option("use-http",{description:"set if your ILIAS installation uses http (e.g. for local development or reverse proxies)",type:"boolean",default:0}).demandOption(["client-id"]).help().alias("help","h").argv,client_id=argv.clientId,ilias_installation_dir=argv.iliasDir?argv.iliasDir.replace(/\/+$/,""):"/var/www/ilias",port=argv.port,ip=argv.ip,protocol=argv.useHttp?"http":"https",express=require("express"),app=express(),http=require(protocol).createServer(app),io=require("socket.io")(http),ejs=require("ejs"),fs=require("fs"),index_file=fs.readFileSync(__dirname+"/templates/index.ejs","utf8"),QueryUtils=require("./modules/QueryUtils.js");QueryUtils.init(client_id,ilias_installation_dir),QueryUtils.writeChatServerConfig(ip,port,protocol),app.use(express.static(__dirname+"/public")),app.get("/srchat/get_profile_picture/:usr_id",function(a,b){var c=ilias_installation_dir+"/data/"+client_id+"/usr_images/usr_"+a.params.usr_id+"_xsmall.jpg";try{fs.existsSync(c)?b.sendFile(c):b.sendFile(ilias_installation_dir+"/templates/default/images/no_photo_xsmall.jpg")}catch(a){b.sendFile(ilias_installation_dir+"/templates/default/images/no_photo_xsmall.jpg")}}),app.get("/srchat/open_chat/:token",async function(a,b){try{var c=await QueryUtils.checkAndFetchToken(a.params.token),d={token:a.params.token,client_id:client_id,base_url:protocol+"://"+a.hostname,public_name:c.public_name,usr_id:c.usr_id,chat_room_id:c.chat_room_id,messages:await QueryUtils.getOldMessages(c.chat_room_id)};return b.send(ejs.render(index_file,d))}catch(c){console.log("check failed for token "+a.params.token+" with error message: "+c.message),b.sendFile(__dirname+"/templates/error.html")}}),io.use(async function(a,b){if("undefined"==typeof a.handshake.query||"string"!=typeof a.handshake.query.token)return console.log("missing token in handshake"),b(new Error("missing token in handshake"));try{var c=await QueryUtils.checkAndFetchToken(a.handshake.query.token)}catch(a){return console.log(a.message),b(new Error(a.message))}return a.usr_id=c.usr_id,a.chat_room_id=c.chat_room_id,a.public_name=c.public_name,b()}),io.on("connection",function(a){console.log("user connected"),a.join("sr_chat_"+a.chat_room_id),a.on("disconnect",function(){console.log("user disconnected")}),a.on("chat_msg",function(b){var c=new Date,d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),e=c.getHours()+":"+c.getMinutes();io.to("sr_chat_"+a.chat_room_id).emit("chat_msg",{public_name:a.public_name,msg:b,sent_at:e,usr_id:a.usr_id}),QueryUtils.insertMessage(a.chat_room_id,a.usr_id,b,d+" "+e)})}),http.listen(port,ip,511,function(){console.log("listening on "+ip+":"+port)});